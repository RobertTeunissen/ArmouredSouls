## Purpose

Verify that the backend correctly enforces Training Academy caps according to STABLE_SYSTEM.md specifications.

## Background

The backend code was updated in commit c11692c to implement the correct cap mapping from STABLE_SYSTEM.md. This issue tracks verification that the implementation is working correctly.

## Backend Implementation

**File**: `prototype/backend/src/routes/robots.ts`
**Lines**: ~312-343 (attribute upgrade endpoint)

```typescript
const getCapForLevel = (level: number): number => {
  const capMap: { [key: number]: number } = {
    0: 10, 1: 15, 2: 20, 3: 25, 4: 30,
    5: 35, 6: 40, 7: 42, 8: 45, 9: 48, 10: 50
  };
  return capMap[level] || 10;
};

// Cap enforcement
const academyType = attributeToAcademy[attribute];
let attributeCap = 10; // Base cap without any academy

if (academyType) {
  const academy = await prisma.facility.findFirst({
    where: { userId, facilityType: academyType },
  });
  const academyLevel = academy?.level || 0;
  attributeCap = getCapForLevel(academyLevel);
}

// Enforce cap for ALL attributes
if (newLevel > attributeCap) {
  return res.status(400).json({
    error: `Attribute cap of ${attributeCap} reached. Upgrade ${academyName} to increase cap.`
  });
}
```

## Verification Tests

### Test 1: Base Cap Without Academy

**Setup**: No academies upgraded (all Level 0)

**Test**: Try to upgrade Combat Power from level 10 to level 11

**Expected**: 
- Request fails with status 400
- Error message: "Attribute cap of 10 reached. Upgrade Combat Training Academy to increase cap."

**Actual**: ❓ Needs testing

### Test 2: Academy Level 1 Cap

**Setup**: Upgrade Combat Training Academy to Level 1

**Test**: 
1. Try to upgrade Combat Power to level 11 → Should succeed
2. Try to upgrade Combat Power to level 15 → Should succeed
3. Try to upgrade Combat Power to level 16 → Should fail

**Expected**: 
- Levels 1-15 allowed
- Level 16 blocked with error: "Attribute cap of 15 reached..."

**Actual**: ❓ Needs testing

### Test 3: All 4 Academies

Test each academy controls its respective attributes:

**Combat Training Academy → Combat Systems**:
- combatPower, penetration, targetingSystems, criticalSystems, weaponControl, attackSpeed

**Defense Training Academy → Defensive Systems**:
- hullIntegrity, armorPlating, shieldCapacity, damageDampeners, counterProtocols

**Mobility Training Academy → Chassis & Mobility**:
- servoMotors, hydraulicSystems, gyroStabilizers, powerCore, evasionThrusters

**AI Training Academy → AI Processing + Team**:
- combatAlgorithms, adaptiveAI, logicCores, syncProtocols, supportSystems, formationTactics, elo

**Test**: Try upgrading an attribute without its corresponding academy

**Expected**: Blocked at level 10

**Actual**: ❓ Needs testing

### Test 4: Maximum Cap (Level 10)

**Setup**: Upgrade Combat Training Academy to Level 10

**Test**: 
1. Try to upgrade Combat Power to level 50 → Should succeed
2. Try to upgrade Combat Power to level 51 → Should fail

**Expected**: 
- Level 50 allowed
- Level 51 blocked with error: "Attribute cap of 50 reached..."

**Actual**: ❓ Needs testing

## Testing Methods

### Option 1: Manual API Testing with curl

```bash
# Test upgrading past cap
curl -X POST http://localhost:3001/api/robots/1/upgrade \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"attribute":"combatPower"}'
```

### Option 2: Frontend Testing

1. Create robot
2. Upgrade attribute 10 times (to level 10)
3. Try to upgrade 11th time
4. Should see error message

### Option 3: Automated Testing

Create integration test in backend test suite:

```typescript
describe('Training Academy caps', () => {
  it('blocks upgrade past level 10 without academy', async () => {
    // Test implementation
  });
  
  it('allows upgrade to level 15 with academy level 1', async () => {
    // Test implementation
  });
});
```

## Cap Progression Reference

From **STABLE_SYSTEM.md** (lines 196-245):

| Academy Level | Attribute Cap |
|--------------|---------------|
| 0 | 10 |
| 1 | 15 |
| 2 | 20 |
| 3 | 25 |
| 4 | 30 |
| 5 | 35 |
| 6 | 40 |
| 7 | 42 |
| 8 | 45 |
| 9 | 48 |
| 10 | 50 |

## Related Documentation

- **STABLE_SYSTEM.md** lines 196-245 (Training Academy specifications)
- **MILESTONE_3_VERIFICATION.md** Test #2 (Backend cap enforcement test)
- **ROBOT_ATTRIBUTES.md** (Attribute specifications)

## Acceptance Criteria

- [ ] Base cap of 10 enforced without any academy
- [ ] Cap increases correctly with academy level
- [ ] All 4 academies control their respective attribute groups
- [ ] Error messages are clear and helpful
- [ ] Maximum cap of 50 enforced at academy level 10
- [ ] Caps enforced even for attributes not explicitly mapped
- [ ] No attributes can exceed their cap regardless of method

## Notes

The code looks correct based on review. This is primarily a verification task to ensure it works as expected in practice.
