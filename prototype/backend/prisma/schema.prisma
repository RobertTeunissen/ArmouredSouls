// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int     @id @default(autoincrement())
  username     String  @unique @db.VarChar(50)
  email        String? @unique @db.VarChar(20)
  passwordHash String  @map("password_hash") @db.VarChar(255)
  role         String  @default("user") @db.VarChar(20) // "user", "admin"

  // ===== RESOURCES =====
  currency Int @default(3000000) // Credits (₡) - Starting: ₡3,000,000
  prestige Int @default(0) // Stable reputation (earned, never spent)

  // ===== STABLE STATISTICS (Aggregated from robots) =====
  championshipTitles Int @default(0) @map("championship_titles") // Tournament victories

  // ===== PROFILE FIELDS =====
  stableName            String?  @unique @map("stable_name") @db.VarChar(30)
  profileVisibility     String   @default("public") @map("profile_visibility") @db.VarChar(10)
  notificationsBattle   Boolean  @default(true) @map("notifications_battle")
  notificationsLeague   Boolean  @default(true) @map("notifications_league")
  themePreference       String   @default("dark") @map("theme_preference") @db.VarChar(20)

  // ===== TIMESTAMPS =====
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // ===== RELATIONS =====
  robots          Robot[]
  facilities      Facility[]
  weaponInventory WeaponInventory[]
  tagTeams        TagTeam[]

  @@map("users")
}

model Facility {
  id           Int    @id @default(autoincrement())
  userId       Int    @map("user_id")
  facilityType String @map("facility_type") @db.VarChar(50) // See 14 facility types in doc
  level        Int    @default(0) // Current level (0-10, where 0 = not purchased)
  maxLevel     Int    @default(10) @map("max_level") // Maximum level (10 for most, 9 for Roster Expansion)

  // ===== COACHING STAFF SPECIFIC =====
  activeCoach String? @map("active_coach") @db.VarChar(50) // For coaching_staff: active coach type

  // ===== TIMESTAMPS =====
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // ===== RELATIONS =====
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, facilityType])
  @@index([userId])
  @@map("facilities")
}

model Robot {
  id       Int     @id @default(autoincrement())
  userId   Int     @map("user_id")
  name     String  @db.VarChar(50)
  frameId  Int     @default(1) @map("frame_id") // Chassis appearance ID
  paintJob String? @map("paint_job") @db.VarChar(100) // Cosmetic customization

  // ===== 23 CORE ATTRIBUTES (Range: 1.00-50.00, precision 2 decimals) =====

  // Combat Systems (6 attributes)
  combatPower      Decimal @default(1.00) @map("combat_power") @db.Decimal(5, 2) // Base damage multiplier (all weapons)
  targetingSystems Decimal @default(1.00) @map("targeting_systems") @db.Decimal(5, 2) // Hit chance, accuracy
  criticalSystems  Decimal @default(1.00) @map("critical_systems") @db.Decimal(5, 2) // Critical hit chance
  penetration      Decimal @default(1.00) @db.Decimal(5, 2) // Bypasses armor/shields
  weaponControl    Decimal @default(1.00) @map("weapon_control") @db.Decimal(5, 2) // Weapon handling, damage multiplier
  attackSpeed      Decimal @default(1.00) @map("attack_speed") @db.Decimal(5, 2) // Cooldown reduction

  // Defensive Systems (5 attributes)
  armorPlating     Decimal @default(1.00) @map("armor_plating") @db.Decimal(5, 2) // Physical damage reduction
  shieldCapacity   Decimal @default(1.00) @map("shield_capacity") @db.Decimal(5, 2) // Max energy shield HP
  evasionThrusters Decimal @default(1.00) @map("evasion_thrusters") @db.Decimal(5, 2) // Dodge chance
  damageDampeners  Decimal @default(1.00) @map("damage_dampeners") @db.Decimal(5, 2) // Critical damage reduction
  counterProtocols Decimal @default(1.00) @map("counter_protocols") @db.Decimal(5, 2) // Counter-attack chance

  // Chassis & Mobility (5 attributes)
  hullIntegrity    Decimal @default(1.00) @map("hull_integrity") @db.Decimal(5, 2) // Max HP (×10 formula)
  servoMotors      Decimal @default(1.00) @map("servo_motors") @db.Decimal(5, 2) // Movement speed, positioning
  gyroStabilizers  Decimal @default(1.00) @map("gyro_stabilizers") @db.Decimal(5, 2) // Balance, reaction time
  hydraulicSystems Decimal @default(1.00) @map("hydraulic_systems") @db.Decimal(5, 2) // Melee damage bonus, force
  powerCore        Decimal @default(1.00) @map("power_core") @db.Decimal(5, 2) // Energy shield regen rate

  // AI Processing (4 attributes)
  combatAlgorithms Decimal @default(1.00) @map("combat_algorithms") @db.Decimal(5, 2) // Decision quality
  threatAnalysis   Decimal @default(1.00) @map("threat_analysis") @db.Decimal(5, 2) // Target priority, positioning
  adaptiveAI       Decimal @default(1.00) @map("adaptive_ai") @db.Decimal(5, 2) // Learning over time
  logicCores       Decimal @default(1.00) @map("logic_cores") @db.Decimal(5, 2) // Performance under pressure

  // Team Coordination (3 attributes) - for 2v2, 3v3+ arena battles
  syncProtocols    Decimal @default(1.00) @map("sync_protocols") @db.Decimal(5, 2) // Team damage multipliers
  supportSystems   Decimal @default(1.00) @map("support_systems") @db.Decimal(5, 2) // Buff adjacent allies
  formationTactics Decimal @default(1.00) @map("formation_tactics") @db.Decimal(5, 2) // Formation bonuses

  // ===== COMBAT STATE =====
  currentHP     Int @map("current_hp") // Current health (max = hullIntegrity × 10)
  maxHP         Int @map("max_hp") // Max HP (calculated: hullIntegrity × 10)
  currentShield Int @map("current_shield") // Current energy shield HP
  maxShield     Int @map("max_shield") // Max shield (calculated: shieldCapacity × 2)
  damageTaken   Int @default(0) @map("damage_taken") // Damage since last repair

  // ===== PERFORMANCE TRACKING =====
  elo                 Int @default(1200) // Individual skill rating
  totalBattles        Int @default(0) @map("total_battles") // Lifetime battle count
  wins                Int @default(0) // Victory count
  draws               Int @default(0) // Draw count
  losses              Int @default(0) // Defeat count
  damageDealtLifetime Int @default(0) @map("damage_dealt_lifetime") // Total damage output
  damageTakenLifetime Int @default(0) @map("damage_taken_lifetime") // Total damage received
  kills               Int @default(0) // Opponents destroyed (0 HP)

  // ===== LEAGUE & FAME =====
  currentLeague         String  @default("bronze") @map("current_league") @db.VarChar(20) // bronze/silver/gold/platinum/diamond/champion
  leagueId              String  @default("bronze_1") @map("league_id") @db.VarChar(30) // Specific league instance (supports multiple Bronze leagues)
  leaguePoints          Int     @default(0) @map("league_points") // Points for promotion/demotion
  cyclesInCurrentLeague Int     @default(0) @map("cycles_in_current_league") // Number of cycles robot has been in current league
  fame                  Int     @default(0) // Individual robot reputation
  titles                String? @db.Text // Comma-separated achievements

  // ===== TAG TEAM STATISTICS =====
  totalTagTeamBattles Int @default(0) @map("total_tag_team_battles") // Lifetime tag team battle count
  totalTagTeamWins    Int @default(0) @map("total_tag_team_wins") // Tag team victory count
  totalTagTeamLosses  Int @default(0) @map("total_tag_team_losses") // Tag team defeat count
  totalTagTeamDraws   Int @default(0) @map("total_tag_team_draws") // Tag team draw count
  timesTaggedIn       Int @default(0) @map("times_tagged_in") // Number of times robot tagged in as reserve
  timesTaggedOut      Int @default(0) @map("times_tagged_out") // Number of times robot tagged out (yield or destruction)

  // ===== ECONOMIC STATE =====
  repairCost       Int @default(0) @map("repair_cost") // Cost to fully repair (formula-based)
  battleReadiness  Int @default(100) @map("battle_readiness") // Percentage (100% = full HP, 0% = critical)
  totalRepairsPaid Int @default(0) @map("total_repairs_paid") // Lifetime repair costs

  // ===== PLAYER CONFIGURATION (Settings, NOT upgradeable attributes) =====
  yieldThreshold Int    @default(10) @map("yield_threshold") // HP % where robot surrenders (0-50%)
  loadoutType    String @default("single") @map("loadout_type") @db.VarChar(20) // "single", "weapon_shield", "two_handed", "dual_wield"
  stance         String @default("balanced") @db.VarChar(20) // "offensive", "defensive", "balanced"

  // ===== EQUIPMENT (Weapon Inventory System) =====
  mainWeaponId    Int? @map("main_weapon_id") // Primary weapon (all loadouts)
  offhandWeaponId Int? @map("offhand_weapon_id") // Secondary weapon (dual-wield, weapon+shield)

  // ===== APPEARANCE (Optional - null means use default icon) =====
  imageUrl String? @map("image_url") @db.VarChar(255) // Path to selected image, null = no image selected

  // ===== TIMESTAMPS =====
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // ===== RELATIONS =====
  user                      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  mainWeapon                WeaponInventory?  @relation("MainWeapon", fields: [mainWeaponId], references: [id])
  offhandWeapon             WeaponInventory?  @relation("OffhandWeapon", fields: [offhandWeaponId], references: [id])
  battlesAsRobot1           Battle[]          @relation("Robot1")
  battlesAsRobot2           Battle[]          @relation("Robot2")
  scheduledMatchesAsRobot1  ScheduledMatch[]  @relation("ScheduledRobot1")
  scheduledMatchesAsRobot2  ScheduledMatch[]  @relation("ScheduledRobot2")
  tournamentsWon            Tournament[]      @relation("TournamentWinner")
  tournamentMatchesAsRobot1 TournamentMatch[] @relation("TournamentRobot1")
  tournamentMatchesAsRobot2 TournamentMatch[] @relation("TournamentRobot2")
  tournamentMatchesWon      TournamentMatch[]         @relation("TournamentMatchWinner")
  tagTeamsAsActive          TagTeam[]                 @relation("TagTeamActiveRobot")
  tagTeamsAsReserve         TagTeam[]                 @relation("TagTeamReserveRobot")
  battleParticipations      BattleParticipant[]

  @@unique([userId, name])
  @@index([userId])
  @@index([elo])
  @@index([currentLeague])
  @@index([currentLeague, leagueId])
  @@map("robots")
}

model WeaponInventory {
  id       Int @id @default(autoincrement())
  userId   Int @map("user_id")
  weaponId Int @map("weapon_id")

  // Custom name (optional, for named weapons)
  customName String? @map("custom_name") @db.VarChar(100)

  // ===== TIMESTAMPS =====
  purchasedAt DateTime @default(now()) @map("purchased_at")

  // ===== RELATIONS =====
  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  weapon        Weapon  @relation(fields: [weaponId], references: [id])
  robotsMain    Robot[] @relation("MainWeapon")
  robotsOffhand Robot[] @relation("OffhandWeapon")

  @@index([userId])
  @@index([weaponId])
  @@map("weapon_inventory")
}

model Weapon {
  id              Int     @id @default(autoincrement())
  name            String  @db.VarChar(100)
  weaponType      String  @map("weapon_type") @db.VarChar(20) // "energy", "ballistic", "melee", "shield"
  baseDamage      Int     @map("base_damage") // Base damage value
  cooldown        Int // Seconds between attacks (time-based combat)
  cost            Int // Purchase cost in Credits
  handsRequired   String  @map("hands_required") @db.VarChar(10) // "one", "two", "shield"
  damageType      String  @map("damage_type") @db.VarChar(20) // "energy", "ballistic", "melee", "explosive"
  loadoutType     String  @map("loadout_type") @db.VarChar(20) // "single", "weapon_shield", "two_handed", "dual_wield", "any"
  specialProperty String? @map("special_property") @db.Text // Special effects description
  description     String? @db.Text // Flavor text

  // ===== ATTRIBUTE BONUSES (Can be positive or negative) =====
  // Combat Systems
  combatPowerBonus      Int @default(0) @map("combat_power_bonus")
  targetingSystemsBonus Int @default(0) @map("targeting_systems_bonus")
  criticalSystemsBonus  Int @default(0) @map("critical_systems_bonus")
  penetrationBonus      Int @default(0) @map("penetration_bonus")
  weaponControlBonus    Int @default(0) @map("weapon_control_bonus")
  attackSpeedBonus      Int @default(0) @map("attack_speed_bonus")

  // Defensive Systems
  armorPlatingBonus     Int @default(0) @map("armor_plating_bonus")
  shieldCapacityBonus   Int @default(0) @map("shield_capacity_bonus")
  evasionThrustersBonus Int @default(0) @map("evasion_thrusters_bonus")
  damageDampenersBonus  Int @default(0) @map("damage_dampeners_bonus")
  counterProtocolsBonus Int @default(0) @map("counter_protocols_bonus")

  // Chassis & Mobility
  hullIntegrityBonus    Int @default(0) @map("hull_integrity_bonus")
  servoMotorsBonus      Int @default(0) @map("servo_motors_bonus")
  gyroStabilizersBonus  Int @default(0) @map("gyro_stabilizers_bonus")
  hydraulicSystemsBonus Int @default(0) @map("hydraulic_systems_bonus")
  powerCoreBonus        Int @default(0) @map("power_core_bonus")

  // AI Processing
  combatAlgorithmsBonus Int @default(0) @map("combat_algorithms_bonus")
  threatAnalysisBonus   Int @default(0) @map("threat_analysis_bonus")
  adaptiveAIBonus       Int @default(0) @map("adaptive_ai_bonus")
  logicCoresBonus       Int @default(0) @map("logic_cores_bonus")

  // Team Coordination
  syncProtocolsBonus    Int @default(0) @map("sync_protocols_bonus")
  supportSystemsBonus   Int @default(0) @map("support_systems_bonus")
  formationTacticsBonus Int @default(0) @map("formation_tactics_bonus")

  // ===== TIMESTAMPS =====
  createdAt DateTime @default(now()) @map("created_at")

  // ===== RELATIONS =====
  weaponInventory WeaponInventory[]

  @@map("weapons")
}

model BattleParticipant {
  id               Int     @id @default(autoincrement())
  battleId         Int     @map("battle_id")
  robotId          Int     @map("robot_id")
  team             Int     // 1 or 2
  role             String? @db.VarChar(20) // "active" or "reserve" for tag team, null for 1v1
  
  // Economic effects
  credits          Int
  streamingRevenue Int     @default(0) @map("streaming_revenue")
  
  // Stat changes
  eloBefore        Int     @map("elo_before")
  eloAfter         Int     @map("elo_after")
  prestigeAwarded  Int     @default(0) @map("prestige_awarded")
  fameAwarded      Int     @default(0) @map("fame_awarded")
  
  // Battle stats
  damageDealt      Int     @default(0) @map("damage_dealt")
  finalHP          Int     @map("final_hp")
  yielded          Boolean @default(false)
  destroyed        Boolean @default(false)
  
  // Timestamp
  createdAt        DateTime @default(now()) @map("created_at")
  
  // Relationships
  battle  Battle @relation(fields: [battleId], references: [id], onDelete: Cascade)
  robot   Robot  @relation(fields: [robotId], references: [id])
  
  @@unique([battleId, robotId])
  @@index([battleId])
  @@index([robotId])
  @@index([battleId, team])
  @@map("battle_participants")
}

model Battle {
  id         Int    @id @default(autoincrement())
  robot1Id   Int    @map("robot1_id") // First combatant
  robot2Id   Int    @map("robot2_id") // Second combatant
  winnerId   Int?   @map("winner_id") // Winner's robot ID (null if draw)
  battleType String @map("battle_type") @db.VarChar(20) // "league", "tournament", "tag_team"
  leagueType String @map("league_type") @db.VarChar(20) // "bronze", "silver", "gold", etc.

  // ===== TOURNAMENT REFERENCE (optional) =====
  tournamentId    Int? @map("tournament_id") // Links to tournament if this is a tournament battle
  tournamentRound Int? @map("tournament_round") // Round number in tournament

  // ===== TAG TEAM FIELDS (optional) =====
  team1ActiveRobotId  Int?    @map("team1_active_robot_id") // Team 1's active robot
  team1ReserveRobotId Int?    @map("team1_reserve_robot_id") // Team 1's reserve robot
  team2ActiveRobotId  Int?    @map("team2_active_robot_id") // Team 2's active robot
  team2ReserveRobotId Int?    @map("team2_reserve_robot_id") // Team 2's reserve robot
  team1TagOutTime     BigInt? @map("team1_tag_out_time") // Timestamp when team 1 tagged out (milliseconds)
  team2TagOutTime     BigInt? @map("team2_tag_out_time") // Timestamp when team 2 tagged out (milliseconds)

  // ===== TIME-BASED COMBAT DATA =====
  battleLog       Json @map("battle_log") // Complete time-based combat simulation (events with timestamps)
  durationSeconds Int  @map("duration_seconds") // Battle length in seconds

  // ===== ECONOMIC DATA =====
  winnerReward Int? @map("winner_reward") // Credits awarded to winner
  loserReward  Int? @map("loser_reward") // Credits awarded to loser (can earn on loss)

  // ===== TAG TEAM PER-ROBOT STATS =====
  // Individual robot contributions for tag team battles (0 for non-tag-team battles)
  team1ActiveDamageDealt   Int @default(0) @map("team1_active_damage_dealt")
  team1ReserveDamageDealt  Int @default(0) @map("team1_reserve_damage_dealt")
  team2ActiveDamageDealt   Int @default(0) @map("team2_active_damage_dealt")
  team2ReserveDamageDealt  Int @default(0) @map("team2_reserve_damage_dealt")
  team1ActiveFameAwarded   Int @default(0) @map("team1_active_fame_awarded")
  team1ReserveFameAwarded  Int @default(0) @map("team1_reserve_fame_awarded")
  team2ActiveFameAwarded   Int @default(0) @map("team2_active_fame_awarded")
  team2ReserveFameAwarded  Int @default(0) @map("team2_reserve_fame_awarded")

  // ===== ELO TRACKING (kept for backward compatibility and aggregate queries) =====
  robot1ELOBefore Int @map("robot1_elo_before") // ELO before battle
  robot2ELOBefore Int @map("robot2_elo_before") // ELO before battle
  robot1ELOAfter  Int @map("robot1_elo_after") // ELO after battle
  robot2ELOAfter  Int @map("robot2_elo_after") // ELO after battle
  eloChange       Int @map("elo_change") // ELO delta (winner's perspective)

  // ===== TIMESTAMPS =====
  createdAt DateTime @default(now()) @map("created_at")

  // ===== RELATIONS =====
  robot1            Robot                @relation("Robot1", fields: [robot1Id], references: [id])
  robot2            Robot                @relation("Robot2", fields: [robot2Id], references: [id])
  tournament        Tournament?          @relation("TournamentBattles", fields: [tournamentId], references: [id])
  scheduledMatch    ScheduledMatch[]
  tournamentMatches TournamentMatch[]
  tagTeamMatches    TagTeamMatch[]       @relation("TagTeamBattle")
  participants      BattleParticipant[]  // Per-participant battle data (NEW - use this instead of robot1/robot2 columns)

  @@index([robot1Id])
  @@index([robot2Id])
  @@index([createdAt])
  @@index([tournamentId])
  @@index([battleType])
  @@map("battles")
}

model ScheduledMatch {
  id           Int      @id @default(autoincrement())
  robot1Id     Int      @map("robot1_id")
  robot2Id     Int      @map("robot2_id")
  leagueType   String   @map("league_type") @db.VarChar(20) // "bronze", "silver", "gold", etc.
  scheduledFor DateTime @map("scheduled_for") // When the match should be executed
  status       String   @default("scheduled") @db.VarChar(20) // "scheduled", "completed", "cancelled"
  battleId     Int?     @map("battle_id") // Links to Battle after completion
  createdAt    DateTime @default(now()) @map("created_at")

  // ===== RELATIONS =====
  robot1 Robot   @relation("ScheduledRobot1", fields: [robot1Id], references: [id])
  robot2 Robot   @relation("ScheduledRobot2", fields: [robot2Id], references: [id])
  battle Battle? @relation(fields: [battleId], references: [id])

  @@index([robot1Id])
  @@index([robot2Id])
  @@index([scheduledFor, status])
  @@index([status])
  @@map("scheduled_matches")
}

// Singleton table for tracking global cycle state across all admin operations.
// This table should contain exactly one record with id=1. The default(1) ensures
// all operations reference the same row. Created during seed and auto-created
// if missing in admin routes.
model CycleMetadata {
  id          Int       @id @default(1)
  totalCycles Int       @default(0) @map("total_cycles")
  lastCycleAt DateTime? @map("last_cycle_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("cycle_metadata")
}

// Audit log table for event sourcing - stores all game events with flexible JSONB payload
model AuditLog {
  id              BigInt   @id @default(autoincrement())
  cycleNumber     Int      @map("cycle_number")
  eventType       String   @map("event_type") @db.VarChar(100)
  eventTimestamp  DateTime @default(now()) @map("event_timestamp")
  sequenceNumber  Int      @map("sequence_number") // Unique within cycle for ordering
  
  // References (nullable for system-wide events)
  userId          Int?     @map("user_id")
  robotId         Int?     @map("robot_id")
  battleId        Int?     @map("battle_id") // For battle_complete events
  
  // Flexible event data
  payload         Json
  
  // Optional calculation metadata for debugging
  metadata        Json?
  
  @@unique([cycleNumber, sequenceNumber], name: "audit_logs_cycle_sequence")
  @@index([cycleNumber])
  @@index([userId])
  @@index([robotId])
  @@index([battleId])
  @@index([eventType])
  @@index([eventTimestamp])
  @@index([cycleNumber, userId])
  @@index([cycleNumber, robotId])
  @@index([cycleNumber, battleId])
  @@index([cycleNumber, eventType])
  @@map("audit_logs")
}

// Cycle snapshot table for pre-aggregated metrics for fast historical queries
model CycleSnapshot {
  id                     Int      @id @default(autoincrement())
  cycleNumber            Int      @unique @map("cycle_number")
  triggerType            String   @map("trigger_type") @db.VarChar(20) // "manual" or "scheduled"
  
  // Timing
  startTime              DateTime @map("start_time")
  endTime                DateTime @map("end_time")
  durationMs             Int      @map("duration_ms")
  
  // Aggregated data (computed from audit_logs and existing tables)
  stableMetrics          Json     @map("stable_metrics")
  robotMetrics           Json     @map("robot_metrics")
  stepDurations          Json     @map("step_durations")
  
  // Summary statistics (for quick filtering)
  totalBattles           Int      @default(0) @map("total_battles")
  totalCreditsTransacted BigInt   @default(0) @map("total_credits_transacted")
  totalPrestigeAwarded   Int      @default(0) @map("total_prestige_awarded")
  
  createdAt              DateTime @default(now()) @map("created_at")
  
  @@index([cycleNumber])
  @@index([startTime])
  @@map("cycle_snapshots")
}

// Tournament model for tracking competitive elimination events
model Tournament {
  id             Int    @id @default(autoincrement())
  name           String @db.VarChar(100) // "Tournament #1", "Grand Championship"
  tournamentType String @map("tournament_type") @db.VarChar(50) // "single_elimination", "double_elimination", "swiss"
  status         String @default("pending") @db.VarChar(20) // "pending", "active", "completed"

  // Progression tracking
  currentRound      Int @default(1) @map("current_round") // Current round number (1-based)
  maxRounds         Int @map("max_rounds") // Total rounds (calculated from participants)
  totalParticipants Int @map("total_participants") // Number of robots at start

  // Winner tracking
  winnerId Int? @map("winner_id") // Winner's robot ID (null until completed)

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  startedAt   DateTime? @map("started_at") // When first round started
  completedAt DateTime? @map("completed_at") // When tournament finished

  // Relations
  winner  Robot?            @relation("TournamentWinner", fields: [winnerId], references: [id])
  matches TournamentMatch[]
  battles Battle[]          @relation("TournamentBattles")

  @@index([status])
  @@index([winnerId])
  @@map("tournaments")
}

// Tournament match model for tracking individual battles within a tournament
model TournamentMatch {
  id           Int @id @default(autoincrement())
  tournamentId Int @map("tournament_id")
  round        Int // Round number (1 = first round, 2 = quarter-finals, etc.)
  matchNumber  Int @map("match_number") // Position in round (1, 2, 3, ...)

  // Participants
  robot1Id Int? @map("robot1_id") // Null for placeholder matches
  robot2Id Int? @map("robot2_id") // Null for bye matches or placeholders

  // Result
  winnerId   Int?    @map("winner_id") // Winner's robot ID (null until completed)
  battleId   Int?    @unique @map("battle_id") // Links to Battle record
  status     String  @default("pending") @db.VarChar(20) // "pending", "scheduled", "completed"
  isByeMatch Boolean @default(false) @map("is_bye_match") // True if robot advances without battle

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  completedAt DateTime? @map("completed_at")

  // Relations
  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  robot1     Robot?     @relation("TournamentRobot1", fields: [robot1Id], references: [id])
  robot2     Robot?     @relation("TournamentRobot2", fields: [robot2Id], references: [id])
  winner     Robot?     @relation("TournamentMatchWinner", fields: [winnerId], references: [id])
  battle     Battle?    @relation(fields: [battleId], references: [id])

  @@index([tournamentId, round])
  @@index([status])
  @@index([robot1Id])
  @@index([robot2Id])
  @@map("tournament_matches")
}

// Tag Team model for tracking 2v2 team compositions
model TagTeam {
  id             Int @id @default(autoincrement())
  stableId       Int @map("stable_id") // Owner's user ID
  activeRobotId  Int @map("active_robot_id") // Robot that starts the match
  reserveRobotId Int @map("reserve_robot_id") // Robot that tags in

  // League tracking
  tagTeamLeague         String @default("bronze") @map("tag_team_league") @db.VarChar(20) // bronze/silver/gold/platinum/diamond/champion
  tagTeamLeagueId       String @default("bronze_1") @map("tag_team_league_id") @db.VarChar(30) // Specific instance: bronze_1, bronze_2, etc.
  tagTeamLeaguePoints   Int    @default(0) @map("tag_team_league_points") // Points for promotion/demotion
  cyclesInTagTeamLeague Int    @default(0) @map("cycles_in_tag_team_league") // Number of cycles in current league

  // Performance tracking
  totalTagTeamWins   Int @default(0) @map("total_tag_team_wins")
  totalTagTeamLosses Int @default(0) @map("total_tag_team_losses")
  totalTagTeamDraws  Int @default(0) @map("total_tag_team_draws")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  stable         User           @relation(fields: [stableId], references: [id], onDelete: Cascade)
  activeRobot    Robot          @relation("TagTeamActiveRobot", fields: [activeRobotId], references: [id])
  reserveRobot   Robot          @relation("TagTeamReserveRobot", fields: [reserveRobotId], references: [id])
  matchesAsTeam1 TagTeamMatch[] @relation("Team1")
  matchesAsTeam2 TagTeamMatch[] @relation("Team2")

  @@unique([activeRobotId, reserveRobotId])
  @@index([stableId])
  @@index([tagTeamLeague, tagTeamLeagueId])
  @@index([activeRobotId])
  @@index([reserveRobotId])
  @@map("tag_teams")
}

// Tag Team Match model for tracking scheduled 2v2 battles
model TagTeamMatch {
  id            Int      @id @default(autoincrement())
  team1Id       Int      @map("team1_id")
  team2Id       Int?     @map("team2_id") // Nullable for bye-matches
  tagTeamLeague String   @map("tag_team_league") @db.VarChar(20) // bronze/silver/gold/platinum/diamond/champion
  scheduledFor  DateTime @map("scheduled_for") // When the match should be executed
  status        String   @default("scheduled") @db.VarChar(20) // "scheduled", "completed", "cancelled"
  battleId      Int?     @map("battle_id") // Links to Battle after completion
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  team1  TagTeam  @relation("Team1", fields: [team1Id], references: [id])
  team2  TagTeam? @relation("Team2", fields: [team2Id], references: [id])
  battle Battle?  @relation("TagTeamBattle", fields: [battleId], references: [id])

  @@index([team1Id])
  @@index([team2Id])
  @@index([scheduledFor, status])
  @@index([status])
  @@map("tag_team_matches")
}
