## Problem

Training Facility discount is not displaying on the Robot Detail page after upgrading the Training Facility.

## Steps to Reproduce

1. Login with player1/password123
2. Create a robot "Test Bot" (costs ₡500,000)
3. View robot detail page
4. Note upgrade cost shows: **₡2,000** (for upgrading attribute from level 1 to 2)
5. Navigate to Facilities page
6. Upgrade **Training Facility** to Level 1 (costs ₡300,000)
7. Navigate back to robot detail page
8. **BUG**: Upgrade cost still shows **₡2,000** instead of **₡1,900**

## Expected Behavior

With Training Facility at Level 1, the upgrade cost should show **₡1,900** (5% discount applied).

## Actual Behavior

Upgrade cost still shows **₡2,000** (no discount).

## Root Cause

The `visibilitychange` event listener is not properly refreshing the facility state when navigating back from the Facilities page.

**File**: `prototype/frontend/src/pages/RobotDetailPage.tsx`
**Lines**: 141-155 (visibility listener implementation)

```typescript
useEffect(() => {
  fetchRobotAndWeapons();

  const handleVisibilityChange = () => {
    if (!document.hidden) {
      fetchRobotAndWeapons(); // This should refresh facilities
    }
  };

  document.addEventListener('visibilitychange', handleVisibilityChange);
  
  return () => {
    document.removeEventListener('visibilitychange', handleVisibilityChange);
  };
}, [id]);
```

## Impact

- Users cannot see the Training Facility discount benefit
- Misleading pricing information
- Affects user's ability to make informed upgrade decisions
- Reduces incentive to upgrade Training Facility

## Training Facility Discount Formula

From **STABLE_SYSTEM.md** (lines 93-100):

```
Level 0: 0% discount (₡2,000)
Level 1: 5% discount (₡1,900)
Level 2: 10% discount (₡1,800)
Level 3: 15% discount (₡1,700)
Level 4: 20% discount (₡1,600)
Level 5: 25% discount (₡1,500)
```

Formula: `baseCost × (1 - (trainingLevel × 5 / 100))`

## Code References

**Frontend Display** (`RobotDetailPage.tsx` lines 534-536):
```typescript
const discountedCost = Math.floor(attributeUpgradeCost * (1 - (trainingLevel * 5) / 100));
```

**State Management** (`RobotDetailPage.tsx` lines 188-199):
```typescript
const trainingFacility = facilities.find(
  (f: any) => f.facilityType === 'training_facility'
);
setTrainingLevel(trainingFacility?.level || 0);
```

## Attempted Fixes

- Commit 5c63366: Added visibility listener (didn't work)
- Commit f607702: No changes to this issue
- Commit c378ead: No changes to this issue

## Verification Steps

1. Add console.log to `fetchRobotAndWeapons()` to verify it's being called
2. Check if `trainingLevel` state is being updated
3. Test different navigation methods (browser back button, navigation links)
4. Consider alternative: Use React Router's `useLocation` hook to detect navigation

## Related Documentation

- **STABLE_SYSTEM.md** lines 93-100 (Training Facility specifications)
- **MILESTONE_3_VERIFICATION.md** Test #1 (Training Facility discount test)

## Acceptance Criteria

- [ ] Upgrading Training Facility updates discount immediately
- [ ] Discount shows correctly when navigating back to robot page
- [ ] Discount formula matches STABLE_SYSTEM.md (5% per level)
- [ ] State persists across page navigations
- [ ] Works with browser back button
- [ ] Works with navigation links
